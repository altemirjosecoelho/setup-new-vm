pipeline {
    agent {
        label 'local-agent'
    }
    
    environment {
        // ConfiguraÃ§Ãµes de instalaÃ§Ã£o
        NODE_VERSION = '21.x'
        DOCKER_VERSION = 'latest'
        POSTGRES_VERSION = '15'
        REDIS_VERSION = '7'
        MONGODB_VERSION = '7'
        TRAEFIK_VERSION = 'latest'
        PORTAINER_VERSION = 'latest'
        PGADMIN_VERSION = 'latest'
        
        // ConfiguraÃ§Ãµes de containers
        POSTGRES_CONTAINER = 'postgres-app'
        REDIS_CONTAINER_1 = 'redis-app-6379'
        REDIS_CONTAINER_2 = 'redis-app-6380'
        MONGODB_CONTAINER = 'mongodb-app'
        TRAEFIK_CONTAINER = 'traefik'
        PORTAINER_CONTAINER = 'portainer'
        PGADMIN_CONTAINER = 'pgadmin'
        
        // Portas
        POSTGRES_PORT = '5432'
        REDIS_PORT_1 = '6379'
        REDIS_PORT_2 = '6380'
        MONGODB_PORT = '27017'
        TRAEFIK_PORT = '80'
        TRAEFIK_PORT_SSL = '443'
        PORTAINER_PORT = '9000'
        PGADMIN_PORT = '5050'
        
        // Banco de dados
        POSTGRES_DB = 'appdb'
        MONGODB_DB = 'appdb'
        
        // DomÃ­nios
        TRAEFIK_DOMAIN = 'traefik.testes.possoatender.com'
        PORTAINER_DOMAIN = 'portainer.testes.possoatender.com'
        PGADMIN_DOMAIN = 'pgadmin.testes.possoatender.com'
        
        // Docker Network
        DOCKER_NETWORK = 'traefik_network'
    }
    
    stages {
        stage('Configurar Credenciais') {
            steps {
                script {
                    // ConfiguraÃ§Ãµes de conexÃ£o SSH (devem ser configuradas no Jenkins)
                    env.VM_HOST = env.VM_HOST ?: '135.181.24.29'
                    env.VM_USER = env.VM_USER ?: 'jenkins'
                    env.SSH_KEY_PATH = env.SSH_KEY_PATH ?: '/var/lib/jenkins/.ssh/id_rsa'
                    
                    // Credenciais de banco de dados (devem ser configuradas no Jenkins)
                    env.POSTGRES_PASSWORD = env.POSTGRES_PASSWORD ?: 'postgres123'
                    env.MONGODB_PASSWORD = env.MONGODB_PASSWORD ?: 'mongo123'
                    env.PGADMIN_EMAIL = env.PGADMIN_EMAIL ?: 'admin@admin.com'
                    env.PGADMIN_PASSWORD = env.PGADMIN_PASSWORD ?: 'admin123'
                    env.PORTAINER_PASSWORD = env.PORTAINER_PASSWORD ?: 'my_password'
                    
                    echo 'ğŸ” Credenciais configuradas via variÃ¡veis de ambiente'
                    echo "ğŸ–¥ï¸  VM: ${env.VM_HOST}"
                    echo "ğŸ‘¤ UsuÃ¡rio: ${env.VM_USER}"
                }
            }
        }
        
        stage('Verificar Conectividade') {
            steps {
                script {
                    echo 'ğŸ” Verificando conectividade com a VM...'
                    sh '''
                        # Testa conectividade SSH
                        ssh -i ${SSH_KEY_PATH} -o StrictHostKeyChecking=no ${VM_USER}@${VM_HOST} 'echo "âœ… ConexÃ£o SSH estabelecida"'
                        
                        # Verifica informaÃ§Ãµes bÃ¡sicas da VM
                        ssh -i ${SSH_KEY_PATH} ${VM_USER}@${VM_HOST} '''
                            echo "ğŸ–¥ï¸  Sistema: \$(uname -a)"
                            echo "ğŸ’¾ MemÃ³ria: \$(free -h)"
                            echo "ğŸ’¿ Disco: \$(df -h)"
                            echo "ğŸŒ IP: \$(hostname -I)"
                        '''
                    '''
                }
            }
        }
        
        stage('Verificar DependÃªncias Existentes') {
            steps {
                script {
                    echo 'ğŸ” Verificando dependÃªncias jÃ¡ instaladas...'
                    sh '''
                        ssh -i ${SSH_KEY_PATH} ${VM_USER}@${VM_HOST} '''
                            echo "ğŸ“¦ Verificando Node.js..."
                            if command -v node &> /dev/null; then
                                echo "âœ… Node.js encontrado: \$(node --version)"
                            else
                                echo "âŒ Node.js nÃ£o encontrado"
                            fi
                            
                            echo "ğŸ³ Verificando Docker..."
                            if command -v docker &> /dev/null; then
                                echo "âœ… Docker encontrado: \$(docker --version)"
                            else
                                echo "âŒ Docker nÃ£o encontrado"
                            fi
                            
                            echo "ğŸ“¦ Verificando NPM..."
                            if command -v npm &> /dev/null; then
                                echo "âœ… NPM encontrado: \$(npm --version)"
                            else
                                echo "âŒ NPM nÃ£o encontrado"
                            fi
                            
                            echo "ğŸ”§ Verificando Git..."
                            if command -v git &> /dev/null; then
                                echo "âœ… Git encontrado: \$(git --version)"
                            else
                                echo "âŒ Git nÃ£o encontrado"
                            fi
                        '''
                    '''
                }
            }
        }
        
        stage('Instalar Node.js') {
            when {
                expression {
                    return true // Sempre executa para garantir versÃ£o correta
                }
            }
            steps {
                script {
                    echo 'ğŸ“¦ Instalando/Atualizando Node.js...'
                    sh '''
                        ssh -i ${SSH_KEY_PATH} ${VM_USER}@${VM_HOST} '''
                            # Atualiza repositÃ³rios
                            sudo apt-get update
                            
                            # Remove versÃµes antigas do Node.js
                            sudo apt-get remove -y nodejs npm || true
                            
                            # Instala Node.js via NodeSource
                            curl -fsSL https://deb.nodesource.com/setup_${NODE_VERSION} | sudo -E bash -
                            sudo apt-get install -y nodejs
                            
                            # Verifica instalaÃ§Ã£o
                            echo "âœ… Node.js instalado: \$(node --version)"
                            echo "âœ… NPM instalado: \$(npm --version)"
                            
                            # Instala PM2 para gerenciamento de processos
                            sudo npm install -g pm2
                            echo "âœ… PM2 instalado: \$(pm2 --version)"
                        '''
                    '''
                }
            }
        }
        
        stage('Instalar Docker') {
            when {
                expression {
                    return true // Sempre executa para garantir versÃ£o correta
                }
            }
            steps {
                script {
                    echo 'ğŸ³ Instalando/Atualizando Docker...'
                    sh '''
                        ssh -i ${SSH_KEY_PATH} ${VM_USER}@${VM_HOST} '''
                            # Remove versÃµes antigas
                            sudo apt-get remove -y docker docker-engine docker.io containerd runc || true
                            
                            # Instala dependÃªncias
                            sudo apt-get update
                            sudo apt-get install -y apt-transport-https ca-certificates curl gnupg lsb-release
                            
                            # Adiciona repositÃ³rio oficial do Docker
                            curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
                            echo "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu \$(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
                            
                            # Instala Docker
                            sudo apt-get update
                            sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin
                            
                            # Adiciona usuÃ¡rio ao grupo docker
                            sudo usermod -aG docker ${USER}
                            
                            # Inicia e habilita Docker
                            sudo systemctl start docker
                            sudo systemctl enable docker
                            
                            # Verifica instalaÃ§Ã£o
                            echo "âœ… Docker instalado: \$(docker --version)"
                            echo "âœ… Docker Compose instalado: \$(docker compose version)"
                        '''
                    '''
                }
            }
        }
        
        stage('Configurar Infraestrutura Docker') {
            steps {
                script {
                    echo 'ğŸ—ï¸ Configurando infraestrutura Docker completa...'
                    sh '''
                        ssh -i ${SSH_KEY_PATH} ${VM_USER}@${VM_HOST} '''
                            # Para containers existentes
                            docker stop ${TRAEFIK_CONTAINER} ${PORTAINER_CONTAINER} ${POSTGRES_CONTAINER} ${REDIS_CONTAINER_1} ${REDIS_CONTAINER_2} ${MONGODB_CONTAINER} ${PGADMIN_CONTAINER} || true
                            docker rm ${TRAEFIK_CONTAINER} ${PORTAINER_CONTAINER} ${POSTGRES_CONTAINER} ${REDIS_CONTAINER_1} ${REDIS_CONTAINER_2} ${MONGODB_CONTAINER} ${PGADMIN_CONTAINER} || true
                            
                            # Cria rede para containers
                            docker network create ${DOCKER_NETWORK} || true
                            
                            # Cria diretÃ³rios para volumes
                            sudo mkdir -p /opt/docker/volumes/postgres
                            sudo mkdir -p /opt/docker/volumes/redis-6380
                            sudo mkdir -p /opt/docker/volumes/mongodb
                            sudo mkdir -p /opt/docker/volumes/traefik
                            sudo mkdir -p /opt/docker/volumes/portainer
                            sudo mkdir -p /opt/docker/volumes/pgadmin
                            
                            # Configura permissÃµes
                            sudo chown -R 1000:1000 /opt/docker/volumes/
                            
                            # Executa Traefik (Load Balancer/Reverse Proxy)
                            docker run -d \\
                                --name ${TRAEFIK_CONTAINER} \\
                                --network ${DOCKER_NETWORK} \\
                                -p ${TRAEFIK_PORT}:80 \\
                                -p ${TRAEFIK_PORT_SSL}:443 \\
                                -v /var/run/docker.sock:/var/run/docker.sock:ro \\
                                -v /opt/docker/volumes/traefik:/etc/traefik \\
                                -l traefik.enable=true \\
                                -l traefik.http.routers.traefik.rule="Host(\`${TRAEFIK_DOMAIN}\`)" \\
                                -l traefik.http.routers.traefik.entrypoints=web \\
                                -l traefik.http.services.traefik.loadbalancer.server.port=8080 \\
                                traefik:${TRAEFIK_VERSION} \\
                                --api.dashboard=true \\
                                --api.insecure=true \\
                                --providers.docker=true \\
                                --providers.docker.exposedbydefault=false \\
                                --entrypoints.web.address=:80 \\
                                --entrypoints.websecure.address=:443
                            
                            # Executa PostgreSQL
                            docker run -d \\
                                --name ${POSTGRES_CONTAINER} \\
                                --network ${DOCKER_NETWORK} \\
                                -e POSTGRES_PASSWORD=${POSTGRES_PASSWORD} \\
                                -e POSTGRES_DB=${POSTGRES_DB} \\
                                -p ${POSTGRES_PORT}:5432 \\
                                -v /opt/docker/volumes/postgres:/var/lib/postgresql/data \\
                                postgres:${POSTGRES_VERSION}
                            
                            # Executa Redis 1 (porta 6379) - SEM persistÃªncia (cache temporÃ¡rio)
                            docker run -d \\
                                --name ${REDIS_CONTAINER_1} \\
                                --network ${DOCKER_NETWORK} \\
                                -p ${REDIS_PORT_1}:6379 \\
                                redis:${REDIS_VERSION} \\
                                redis-server --save "" --appendonly no
                            
                            # Executa Redis 2 (porta 6380) - COM persistÃªncia
                            docker run -d \\
                                --name ${REDIS_CONTAINER_2} \\
                                --network ${DOCKER_NETWORK} \\
                                -p ${REDIS_PORT_2}:6379 \\
                                -v /opt/docker/volumes/redis-6380:/data \\
                                redis:${REDIS_VERSION} \\
                                redis-server --appendonly yes
                            
                            # Executa MongoDB
                            docker run -d \\
                                --name ${MONGODB_CONTAINER} \\
                                --network ${DOCKER_NETWORK} \\
                                -e MONGO_INITDB_ROOT_USERNAME=admin \\
                                -e MONGO_INITDB_ROOT_PASSWORD=${MONGODB_PASSWORD} \\
                                -e MONGO_INITDB_DATABASE=${MONGODB_DB} \\
                                -p ${MONGODB_PORT}:27017 \\
                                -v /opt/docker/volumes/mongodb:/data/db \\
                                mongo:${MONGODB_VERSION}
                            
                            # Executa Portainer
                            docker run -d \\
                                --name ${PORTAINER_CONTAINER} \\
                                --network ${DOCKER_NETWORK} \\
                                -p ${PORTAINER_PORT}:9000 \\
                                -v /var/run/docker.sock:/var/run/docker.sock:ro \\
                                -v /opt/docker/volumes/portainer:/data \\
                                -l traefik.enable=true \\
                                -l traefik.http.routers.portainer.rule="Host(\`${PORTAINER_DOMAIN}\`)" \\
                                -l traefik.http.routers.portainer.entrypoints=web \\
                                -l traefik.http.services.portainer.loadbalancer.server.port=9000 \\
                                portainer/portainer-ce:${PORTAINER_VERSION}
                            
                            # Executa pgAdmin
                            docker run -d \\
                                --name ${PGADMIN_CONTAINER} \\
                                --network ${DOCKER_NETWORK} \\
                                -e PGADMIN_DEFAULT_EMAIL=${PGADMIN_EMAIL} \\
                                -e PGADMIN_DEFAULT_PASSWORD=${PGADMIN_PASSWORD} \\
                                -p ${PGADMIN_PORT}:80 \\
                                -v /opt/docker/volumes/pgadmin:/var/lib/pgadmin \\
                                -l traefik.enable=true \\
                                -l traefik.http.routers.pgadmin.rule="Host(\`${PGADMIN_DOMAIN}\`)" \\
                                -l traefik.http.routers.pgadmin.entrypoints=web \\
                                -l traefik.http.services.pgadmin.loadbalancer.server.port=80 \\
                                dpage/pgadmin4:${PGADMIN_VERSION}
                            
                            # Aguarda inicializaÃ§Ã£o
                            sleep 15
                            
                            # Verifica se containers estÃ£o rodando
                            echo "ğŸ“Š Status dos containers:"
                            docker ps --format "table {{.Names}}\\t{{.Status}}\\t{{.Ports}}"
                            
                            # Testa conexÃµes
                            echo "ğŸ” Testando PostgreSQL..."
                            docker exec ${POSTGRES_CONTAINER} pg_isready -U postgres && echo "âœ… PostgreSQL OK" || echo "âŒ PostgreSQL falhou"
                            
                            echo "ğŸ” Testando Redis 1 (6379)..."
                            docker exec ${REDIS_CONTAINER_1} redis-cli ping && echo "âœ… Redis 1 OK" || echo "âŒ Redis 1 falhou"
                            
                            echo "ğŸ” Testando Redis 2 (6380)..."
                            docker exec ${REDIS_CONTAINER_2} redis-cli ping && echo "âœ… Redis 2 OK" || echo "âŒ Redis 2 falhou"
                            
                            echo "ğŸ” Testando MongoDB..."
                            docker exec ${MONGODB_CONTAINER} mongosh --eval "db.adminCommand('ping')" && echo "âœ… MongoDB OK" || echo "âŒ MongoDB falhou"
                        '''
                    '''
                }
            }
        }
        
        stage('Configurar UsuÃ¡rios e Senhas') {
            steps {
                script {
                    echo 'ğŸ” Configurando usuÃ¡rios e senhas...'
                    sh '''
                        ssh -i ${SSH_KEY_PATH} ${VM_USER}@${VM_HOST} '''
                            echo "ğŸ” Configurando Portainer..."
                            # Aguarda Portainer inicializar completamente
                            sleep 30
                            
                            # Cria arquivo de configuraÃ§Ã£o para Portainer
                            cat > /tmp/portainer-setup.json << EOF
                            {
                                "Username": "admin",
                                "Password": "${PORTAINER_PASSWORD}"
                            }
                            EOF
                            
                            echo "âœ… ConfiguraÃ§Ãµes de usuÃ¡rio criadas"
                            echo "ğŸ“‹ Resumo das credenciais:"
                            echo "   ğŸ³ Portainer: admin / ${PORTAINER_PASSWORD}"
                            echo "   ğŸ—„ï¸  pgAdmin: ${PGADMIN_EMAIL} / ${PGADMIN_PASSWORD}"
                            echo "   ğŸ—„ï¸  PostgreSQL: postgres / ${POSTGRES_PASSWORD}"
                            echo "   ğŸ”´ Redis 6379: sem autenticaÃ§Ã£o (cache temporÃ¡rio, sem persistÃªncia)"
                            echo "   ğŸ”´ Redis 6380: sem autenticaÃ§Ã£o (com persistÃªncia)"
                            echo "   ğŸƒ MongoDB: admin / ${MONGODB_PASSWORD}"
                        '''
                    '''
                }
            }
        }
        
        stage('Instalar Ferramentas Adicionais') {
            steps {
                script {
                    echo 'ğŸ› ï¸ Instalando ferramentas adicionais...'
                    sh '''
                        ssh -i ${SSH_KEY_PATH} ${VM_USER}@${VM_HOST} '''
                            # Atualiza repositÃ³rios
                            sudo apt-get update
                            
                            # Instala ferramentas Ãºteis
                            sudo apt-get install -y \\
                                htop \\
                                tree \\
                                jq \\
                                curl \\
                                wget \\
                                unzip \\
                                git \\
                                vim \\
                                net-tools \\
                                nginx \\
                                certbot \\
                                python3-certbot-nginx
                            
                            # Instala ferramentas de monitoramento
                            sudo npm install -g \\
                                nodemon \\
                                concurrently \\
                                cross-env
                            
                            echo "âœ… Ferramentas adicionais instaladas"
                        '''
                    '''
                }
            }
        }
        
        stage('Configurar Firewall') {
            steps {
                script {
                    echo 'ğŸ”¥ Configurando firewall...'
                    sh '''
                        ssh -i ${SSH_KEY_PATH} ${VM_USER}@${VM_HOST} '''
                            # Instala UFW se nÃ£o estiver instalado
                            sudo apt-get install -y ufw
                            
                            # Configura regras bÃ¡sicas
                            sudo ufw --force reset
                            sudo ufw default deny incoming
                            sudo ufw default allow outgoing
                            
                            # Permite SSH
                            sudo ufw allow ssh
                            
                            # Permite portas da aplicaÃ§Ã£o
                            sudo ufw allow 80/tcp   # HTTP
                            sudo ufw allow 443/tcp  # HTTPS
                            sudo ufw allow 3000/tcp # Node.js app
                            sudo ufw allow 8080/tcp # Jenkins
                            sudo ufw allow 9000/tcp # Portainer
                            sudo ufw allow 5050/tcp # pgAdmin
                            
                            # Habilita firewall
                            sudo ufw --force enable
                            
                            echo "âœ… Firewall configurado"
                            sudo ufw status
                        '''
                    '''
                }
            }
        }
        
        stage('Teste Final do Ambiente') {
            steps {
                script {
                    echo 'ğŸ§ª Executando testes finais do ambiente...'
                    sh '''
                        ssh -i ${SSH_KEY_PATH} ${VM_USER}@${VM_HOST} '''
                            echo "ğŸ” Teste 1: Node.js"
                            node --version && echo "âœ… Node.js OK" || echo "âŒ Node.js falhou"
                            
                            echo "ğŸ” Teste 2: NPM"
                            npm --version && echo "âœ… NPM OK" || echo "âŒ NPM falhou"
                            
                            echo "ğŸ” Teste 3: Docker"
                            docker --version && echo "âœ… Docker OK" || echo "âŒ Docker falhou"
                            
                            echo "ğŸ” Teste 4: PostgreSQL Container"
                            docker exec ${POSTGRES_CONTAINER} pg_isready -U postgres && echo "âœ… PostgreSQL OK" || echo "âŒ PostgreSQL falhou"
                            
                            echo "ğŸ” Teste 5: Redis Container 1 (6379)"
                            docker exec ${REDIS_CONTAINER_1} redis-cli ping && echo "âœ… Redis 1 OK" || echo "âŒ Redis 1 falhou"
                            
                            echo "ğŸ” Teste 6: Redis Container 2 (6380)"
                            docker exec ${REDIS_CONTAINER_2} redis-cli ping && echo "âœ… Redis 2 OK" || echo "âŒ Redis 2 falhou"
                            
                            echo "ğŸ” Teste 7: MongoDB Container"
                            docker exec ${MONGODB_CONTAINER} mongosh --eval "db.adminCommand('ping')" && echo "âœ… MongoDB OK" || echo "âŒ MongoDB falhou"
                            
                            echo "ğŸ” Teste 8: Traefik Container"
                            docker exec ${TRAEFIK_CONTAINER} traefik version && echo "âœ… Traefik OK" || echo "âŒ Traefik falhou"
                            
                            echo "ğŸ” Teste 9: Portainer Container"
                            docker ps | grep ${PORTAINER_CONTAINER} && echo "âœ… Portainer OK" || echo "âŒ Portainer falhou"
                            
                            echo "ğŸ” Teste 10: pgAdmin Container"
                            docker ps | grep ${PGADMIN_CONTAINER} && echo "âœ… pgAdmin OK" || echo "âŒ pgAdmin falhou"
                            
                            echo "ğŸ” Teste 11: PM2"
                            pm2 --version && echo "âœ… PM2 OK" || echo "âŒ PM2 falhou"
                            
                            echo "ğŸ” Teste 12: Git"
                            git --version && echo "âœ… Git OK" || echo "âŒ Git falhou"
                            
                            echo "ğŸ” Teste 13: Nginx"
                            nginx -v && echo "âœ… Nginx OK" || echo "âŒ Nginx falhou"
                        '''
                    '''
                }
            }
        }
    }
    
    post {
        always {
            script {
                echo 'ğŸ Setup da VM finalizado!'
                echo "ğŸ“Š Resumo do ambiente configurado:"
                echo "   ğŸ–¥ï¸  VM: ${VM_HOST}"
                echo "   ğŸ‘¤ UsuÃ¡rio: ${VM_USER}"
                echo "   ğŸ“¦ Node.js: ${NODE_VERSION}"
                echo "   ğŸ³ Docker: ${DOCKER_VERSION}"
                echo "   ğŸ—„ï¸  PostgreSQL: ${POSTGRES_VERSION}"
                echo "   ğŸ”´ Redis: ${REDIS_VERSION} (2 instÃ¢ncias)"
                echo "   ğŸƒ MongoDB: ${MONGODB_VERSION}"
                echo "   ğŸŒ Traefik: ${TRAEFIK_VERSION}"
                echo "   ğŸ³ Portainer: ${PORTAINER_VERSION}"
                echo "   ğŸ“Š pgAdmin: ${PGADMIN_VERSION}"
            }
        }
        success {
            script {
                echo 'ğŸ‰ Setup da VM realizado com sucesso!'
                sh '''
                    ssh -i ${SSH_KEY_PATH} ${VM_USER}@${VM_HOST} '''
                        echo "=========================================="
                        echo "ğŸ¯ INFRAESTRUTURA CONFIGURADA COM SUCESSO"
                        echo "ğŸ–¥ï¸  VM: ${VM_HOST}"
                        echo "ğŸ“¦ Node.js: \$(node --version)"
                        echo "ğŸ³ Docker: \$(docker --version)"
                        echo "ğŸŒ Traefik: https://${TRAEFIK_DOMAIN}"
                        echo "ğŸ³ Portainer: https://${PORTAINER_DOMAIN}"
                        echo "ğŸ“Š pgAdmin: https://${PGADMIN_DOMAIN}"
                        echo "ğŸ—„ï¸  PostgreSQL: Rodando na porta ${POSTGRES_PORT}"
                        echo "ğŸ”´ Redis 1: Rodando na porta ${REDIS_PORT_1} (cache temporÃ¡rio)"
                        echo "ğŸ”´ Redis 2: Rodando na porta ${REDIS_PORT_2} (com persistÃªncia)"
                        echo "ğŸƒ MongoDB: Rodando na porta ${MONGODB_PORT}"
                        echo "ğŸ“Š pgAdmin: Rodando na porta ${PGADMIN_PORT}"
                        echo "ğŸ› ï¸  Ferramentas: PM2, Git, Nginx, etc."
                        echo "ğŸ”¥ Firewall: Configurado e ativo"
                        echo "ğŸŒ Docker Network: ${DOCKER_NETWORK}"
                        echo ""
                        echo "ğŸ” CREDENCIAIS:"
                        echo "   Portainer: admin / ${PORTAINER_PASSWORD}"
                        echo "   pgAdmin: ${PGADMIN_EMAIL} / ${PGADMIN_PASSWORD}"
                        echo "   PostgreSQL: postgres / ${POSTGRES_PASSWORD}"
                        echo "   MongoDB: admin / ${MONGODB_PASSWORD}"
                        echo "=========================================="
                    '''
                '''
            }
        }
        failure {
            script {
                echo 'âŒ Setup da VM falhou!'
                echo 'ğŸ” Verifique os logs para identificar o problema'
                
                // Tenta coletar informaÃ§Ãµes de debug
                sh '''
                    ssh -i ${SSH_KEY_PATH} ${VM_USER}@${VM_HOST} '''
                        echo "=========================================="
                        echo "âŒ SETUP FALHOU - DEBUG INFO"
                        echo "ğŸ–¥ï¸  Sistema: \$(uname -a)"
                        echo "ğŸ’¾ MemÃ³ria: \$(free -h)"
                        echo "ğŸ’¿ Disco: \$(df -h)"
                        echo "ğŸŒ Rede: \$(ip addr show)"
                        echo "ğŸ³ Containers:"
                        docker ps -a
                        echo "=========================================="
                    '''
                '''
            }
        }
        cleanup {
            echo 'ğŸ§¹ Limpeza final...'
        }
    }
} 