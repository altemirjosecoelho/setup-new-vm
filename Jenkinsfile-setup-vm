pipeline {
    agent {
        label 'local-agent'
    }
    
    environment {
        // Configura√ß√µes de conex√£o SSH
        VM_HOST = '135.181.24.29'
        VM_USER = 'ubuntu'  // ou o usu√°rio que voc√™ usa na VM
        VM_PASSWORD = 'sua_senha_aqui'  // configure no Jenkins como vari√°vel de ambiente
        
        // Configura√ß√µes de instala√ß√£o
        NODE_VERSION = '21.x'
        DOCKER_VERSION = 'latest'
        POSTGRES_VERSION = '15'
        REDIS_VERSION = '7'
        MONGODB_VERSION = '7'
        TRAEFIK_VERSION = 'latest'
        PORTAINER_VERSION = 'latest'
        PGADMIN_VERSION = 'latest'
    }
    
    stages {
        stage('Configurar Credenciais') {
            steps {
                script {
                    // Configura√ß√µes de conex√£o SSH
                    env.VM_HOST = env.VM_HOST ?: '135.181.24.29'
                    env.VM_USER = env.VM_USER ?: 'root'
                    env.VM_PASSWORD = env.VM_PASSWORD ?: 'zx100mil!'
                    
                    echo 'üîê Credenciais configuradas'
                    echo "üñ•Ô∏è  VM: ${env.VM_HOST}"
                    echo "üë§ Usu√°rio: ${env.VM_USER}"
                }
            }
        }
        

        
        stage('Teste M√≠nimo') {
            steps {
                script {
                    echo 'üß™ Testando conex√£o SSH e comandos b√°sicos...'
                    
                    sh '''
                        # Testar conex√£o SSH e executar comandos b√°sicos
                        sshpass -p "${VM_PASSWORD}" ssh -o StrictHostKeyChecking=no "${VM_USER}@${VM_HOST}" '
                            echo "‚úÖ Conex√£o SSH estabelecida!"
                            echo "üñ•Ô∏è  Sistema: $(uname -a)"
                            echo "üì¶ Executando apt update..."
                            apt update
                            echo "üì¶ Executando apt upgrade -y..."
                            apt upgrade -y
                            echo "üéâ Teste m√≠nimo conclu√≠do com sucesso!"
                        '
                    '''
                }
            }
        }
    }
    
    post {
        always {
            echo 'üèÅ Setup da VM finalizado!'
        }
        success {
            echo 'üéâ Setup da VM realizado com sucesso!'
        }
        failure {
            echo '‚ùå Setup da VM falhou!'
            echo 'üîç Verifique os logs para identificar o problema'
        }
    }
} 