pipeline {
    agent {
        label 'local-agent'
    }
    
    environment {
        // ConfiguraÃ§Ãµes de conexÃ£o SSH
        VM_HOST = '135.181.24.29'
        VM_USER = 'root'
        VM_PASSWORD = 'zx100mil!'
        
        // ConfiguraÃ§Ãµes de instalaÃ§Ã£o
        NODE_VERSION = '21.x'
        DOCKER_VERSION = 'latest'
        POSTGRES_VERSION = '15'
        REDIS_VERSION = '7'
        MONGODB_VERSION = '7'
        TRAEFIK_VERSION = 'latest'
        PORTAINER_VERSION = 'latest'
        PGADMIN_VERSION = 'latest'
    }
    
    stages {
        stage('Configurar Credenciais') {
            steps {
                script {
                    // ConfiguraÃ§Ãµes de conexÃ£o SSH
                    env.VM_HOST = env.VM_HOST ?: '135.181.24.29'
                    env.VM_USER = env.VM_USER ?: 'root'
                    env.VM_PASSWORD = env.VM_PASSWORD ?: 'zx100mil!'
                    
                    echo 'ðŸ” Credenciais configuradas'
                    echo "ðŸ–¥ï¸  VM: ${env.VM_HOST}"
                    echo "ðŸ‘¤ UsuÃ¡rio: ${env.VM_USER}"
                }
            }
        }
        
        stage('Teste MÃ­nimo com SSH Agent') {
            steps {
                script {
                    echo 'ðŸ§ª Testando conexÃ£o SSH com SSH Agent...'
                    
                    // Usar SSH Agent para conectar
                    sshagent(['jenkins-ssh-key']) {
                        sh '''
                            # Testar conexÃ£o SSH
                            ssh -o StrictHostKeyChecking=no "${VM_USER}@${VM_HOST}" '
                                echo "âœ… ConexÃ£o SSH estabelecida!"
                                echo "ðŸ–¥ï¸  Sistema: $(uname -a)"
                                echo "ðŸ“¦ Executando apt update..."
                                apt update
                                echo "ðŸ“¦ Executando apt upgrade -y..."
                                apt upgrade -y
                                echo "ðŸŽ‰ Teste mÃ­nimo concluÃ­do com sucesso!"
                            '
                        '''
                    }
                }
            }
        }
        
        stage('Teste Alternativo com Senha') {
            when {
                expression {
                    return false // Desabilitado por padrÃ£o, habilite se necessÃ¡rio
                }
            }
            steps {
                script {
                    echo 'ðŸ”‘ Testando com autenticaÃ§Ã£o por senha...'
                    
                    // Usar expect para autenticaÃ§Ã£o por senha
                    sh '''
                        # Verificar se expect estÃ¡ disponÃ­vel
                        if ! command -v expect &> /dev/null; then
                            echo "ðŸ“¦ Instalando expect..."
                            sudo apt-get update
                            sudo apt-get install -y expect
                        fi
                        
                        # Criar script expect
                        cat > /tmp/ssh_test.exp << "EOF"
                        #!/usr/bin/expect -f
                        set timeout 30
                        spawn ssh -o StrictHostKeyChecking=no ${VM_USER}@${VM_HOST}
                        expect "password:"
                        send "${VM_PASSWORD}\r"
                        expect "$ "
                        send "echo 'âœ… ConexÃ£o SSH estabelecida!'\r"
                        send "echo 'ðŸ–¥ï¸  Sistema:' \$(uname -a)\r"
                        send "echo 'ðŸ“¦ Executando apt update...'\r"
                        send "apt update\r"
                        send "echo 'ðŸ“¦ Executando apt upgrade -y...'\r"
                        send "apt upgrade -y\r"
                        send "echo 'ðŸŽ‰ Teste mÃ­nimo concluÃ­do com sucesso!'\r"
                        send "exit\r"
                        expect eof
                        EOF
                        
                        chmod +x /tmp/ssh_test.exp
                        /tmp/ssh_test.exp
                        rm -f /tmp/ssh_test.exp
                    '''
                }
            }
        }
    }
    
    post {
        always {
            echo 'ðŸ Setup da VM finalizado!'
        }
        success {
            echo 'ðŸŽ‰ Setup da VM realizado com sucesso!'
        }
        failure {
            echo 'âŒ Setup da VM falhou!'
            echo 'ðŸ” Verifique os logs para identificar o problema'
            echo 'ðŸ’¡ Dicas:'
            echo '   1. Configure as credenciais SSH no Jenkins'
            echo '   2. Verifique se a VM estÃ¡ acessÃ­vel'
            echo '   3. Use o stage alternativo com senha se necessÃ¡rio'
        }
    }
} 