pipeline {
    agent {
        label 'jenkins-testes'
    }
    
    environment {
        // VariÃ¡veis de ambiente que devem ser configuradas no Jenkins
        // TRAEFIK_SUBDOMAIN=traefik
        // DEFAULT_DOMAIN=exemplo.com
        // PORTAINER_SUBDOMAIN=portainer
        // TRAEFIK_NETWORK=traefik_network
    }
    
    stages {
        stage('Verificar VariÃ¡veis de Ambiente') {
            steps {
                script {
                    echo "=== VERIFICANDO VARIÃVEIS DE AMBIENTE ==="
                    
                    // Verifica se as variÃ¡veis obrigatÃ³rias estÃ£o definidas
                    def requiredVars = ['TRAEFIK_SUBDOMAIN', 'DEFAULT_DOMAIN', 'PORTAINER_SUBDOMAIN', 'ADMIN_PASSWORD', 'REPO_SETUP_NEW_VM']
                    def missingVars = []
                    
                    requiredVars.each { var ->
                        if (!env[var]) {
                            missingVars.add(var)
                        } else {
                            if (var == 'ADMIN_PASSWORD') {
                                echo "âœ… ${var}: [CONFIGURADA]"
                            } else {
                                echo "âœ… ${var}: ${env[var]}"
                            }
                        }
                    }
                    
                    if (missingVars.size() > 0) {
                        error "âŒ VariÃ¡veis obrigatÃ³rias nÃ£o configuradas: ${missingVars.join(', ')}"
                    }
                    
                    // Define a network padrÃ£o se nÃ£o estiver configurada
                    if (!env.TRAEFIK_NETWORK) {
                        env.TRAEFIK_NETWORK = 'traefik_network'
                        echo "â„¹ï¸  TRAEFIK_NETWORK nÃ£o configurada, usando padrÃ£o: ${env.TRAEFIK_NETWORK}"
                    } else {
                        echo "âœ… TRAEFIK_NETWORK: ${env.TRAEFIK_NETWORK}"
                    }
                    
                    // Exibe as URLs que serÃ£o configuradas
                    echo ""
                    echo "=== URLs que serÃ£o configuradas ==="
                    echo "ðŸŒ Traefik: https://${env.TRAEFIK_SUBDOMAIN}.${env.DEFAULT_DOMAIN}"
                    echo "ðŸ³ Portainer: https://${env.PORTAINER_SUBDOMAIN}.${env.DEFAULT_DOMAIN}"
                    echo "ðŸŒ Network: ${env.TRAEFIK_NETWORK}"
                    echo "====================================="
                }
            }
        }
        
        stage('Clonar RepositÃ³rio e Executar Docker Compose') {
            steps {
                script {
                    echo "Clonando repositÃ³rio e executando Docker Compose..."
                    
                    // Verifica se REPO_SETUP_NEW_VM estÃ¡ configurada
                    if (!env.REPO_SETUP_NEW_VM) {
                        error "âŒ VariÃ¡vel REPO_SETUP_NEW_VM nÃ£o configurada! Configure a URL do repositÃ³rio no Jenkins."
                    }
                    
                    echo "ðŸ“¦ Clonando repositÃ³rio: ${env.REPO_SETUP_NEW_VM}"
                    
                    // Remove diretÃ³rio se existir e clona o repositÃ³rio
                    sh '''
                        rm -rf /tmp/setup-new-vm
                        cd /tmp
                        git clone ${REPO_SETUP_NEW_VM} setup-new-vm
                        cd setup-new-vm
                    '''
                    
                    // Cria pasta docker dentro do repositÃ³rio
                    sh '''
                        mkdir -p docker
                        echo "âœ… Pasta docker criada em setup-new-vm/"
                    '''
                    
                    // Lista a estrutura do repositÃ³rio
                    sh '''
                        echo "=== ESTRUTURA DO REPOSITÃ“RIO ==="
                        ls -la
                        echo "================================"
                    '''
                    
                    // Acessa a pasta docker e executa docker compose
                    sh '''
                        cd setup-new-vm/docker
                        echo "ðŸ“ Acessando pasta: $(pwd)"
                        echo "=== CONTEÃšDO DA PASTA DOCKER ==="
                        ls -la
                        echo "================================"
                    '''
                    
                    echo "ðŸš€ Executando docker compose up traefik..."
                    sh '''
                        cd /tmp/setup-new-vm/docker
                        docker compose -f docker-compose.traefik.yml --env-file .env up -d
                    '''
                    
                    echo "ðŸš€ Executando docker compose up portainer..."
                    sh '''
                        cd /tmp/setup-new-vm/docker
                        docker compose -f docker-compose.portainer.yml --env-file .env up -d
                    '''
                    
                    echo "âœ… Docker Compose executado com sucesso!"
                    
                    // Verifica status dos containers
                    sh '''
                        echo "=== STATUS DOS CONTAINERS ==="
                        docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
                        echo "============================="
                    '''
                }
            }
        }
        
        stage('Criar Network Docker') {
            steps {
                script {
                    echo "Criando network Docker para Traefik..."
                    
                    // Verifica se a network jÃ¡ existe
                    def networkExists = sh(
                        script: "docker network ls --format '{{.Name}}' | grep -w '${env.TRAEFIK_NETWORK}'",
                        returnStatus: true
                    ) == 0
                    
                    if (!networkExists) {
                        sh "docker network create ${env.TRAEFIK_NETWORK}"
                        echo "âœ… Network ${env.TRAEFIK_NETWORK} criada com sucesso!"
                    } else {
                        echo "â„¹ï¸  Network ${env.TRAEFIK_NETWORK} jÃ¡ existe!"
                    }
                }
            }
        }
        
        stage('Verificar e Configurar Docker Compose') {
            steps {
                script {
                    echo "Verificando arquivos Docker Compose existentes..."
                    
                    // Gera hash da senha para o Traefik
                    def passwordHash = sh(
                        script: "htpasswd -nbB admin '${env.ADMIN_PASSWORD}' | cut -d ':' -f 2",
                        returnStdout: true
                    ).trim()
                    
                    // Cria arquivo .env com as variÃ¡veis
                    sh """
                        cd /tmp/setup-new-vm/docker
                        cat > .env << 'EOF'
TRAEFIK_SUBDOMAIN=${env.TRAEFIK_SUBDOMAIN}
DEFAULT_DOMAIN=${env.DEFAULT_DOMAIN}
PORTAINER_SUBDOMAIN=${env.PORTAINER_SUBDOMAIN}
ADMIN_PASSWORD_HASH=${passwordHash}
TRAEFIK_NETWORK=${env.TRAEFIK_NETWORK}
DEFAULT_EMAIL=${env.DEFAULT_EMAIL ?: 'admin@' + env.DEFAULT_DOMAIN}
EOF
                    """
                    
                    echo "âœ… Arquivo .env criado com as variÃ¡veis de ambiente!"
                    
                    // Lista todos os arquivos docker-compose existentes
                    sh '''
                        cd /tmp/setup-new-vm/docker
                        echo "=== ARQUIVOS DOCKER COMPOSE ENCONTRADOS ==="
                        ls -la docker-compose*.yml
                        echo "=========================================="
                        
                        echo "=== CONTEÃšDO DO DOCKER-COMPOSE.TRAEFIK.YML ==="
                        if [ -f docker-compose.traefik.yml ]; then
                            cat docker-compose.traefik.yml
                        else
                            echo "âŒ docker-compose.traefik.yml nÃ£o encontrado!"
                        fi
                        echo "============================================="
                        
                        echo "=== CONTEÃšDO DO DOCKER-COMPOSE.PORTAINER.YML ==="
                        if [ -f docker-compose.portainer.yml ]; then
                            cat docker-compose.portainer.yml
                        else
                            echo "âŒ docker-compose.portainer.yml nÃ£o encontrado!"
                        fi
                        echo "==============================================="
                    '''
                    
                    // Exibe o conteÃºdo do arquivo .env
                    sh '''
                        echo "=== CONTEÃšDO DO ARQUIVO .ENV ==="
                        cat .env
                        echo "================================"
                    '''
                    
                    // Cria diretÃ³rios necessÃ¡rios se nÃ£o existirem
                    sh '''
                        cd /tmp/setup-new-vm/docker
                        mkdir -p traefik/config traefik/certificates portainer/data
                        echo "âœ… DiretÃ³rios criados/verificados!"
                    '''
                }
            }
        }
        
        stage('Verificar Status dos Containers') {
            steps {
                script {
                    echo "Verificando status dos containers..."
                    
                    sh '''
                        echo "=== STATUS DOS CONTAINERS ==="
                        docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
                        echo ""
                        echo "=== LOGS DO TRAEFIK ==="
                        docker logs --tail 10 traefik
                        echo ""
                        echo "=== LOGS DO PORTAINER ==="
                        docker logs --tail 10 portainer
                        echo ""
                        echo "=== NETWORKS ==="
                        docker network ls
                        echo ""
                        echo "=== VOLUMES ==="
                        docker volume ls
                    '''
                }
            }
        }
    }
    
    post {
        always {
            script {
                echo "Pipeline de configuraÃ§Ã£o do Traefik e Portainer concluÃ­do!"
            }
        }
        success {
            script {
                echo "âœ… Traefik e Portainer configurados com sucesso!"
                echo ""
                echo "=== RESUMO DA CONFIGURAÃ‡ÃƒO ==="
                echo "ðŸŒ Traefik Dashboard: https://${env.TRAEFIK_SUBDOMAIN}.${env.DEFAULT_DOMAIN}"
                echo "ðŸ‘¤ UsuÃ¡rio Traefik: admin"
                echo "ðŸ”‘ Senha Traefik: [configurada via ADMIN_PASSWORD]"
                echo ""
                echo "ðŸ³ Portainer Dashboard: https://${env.PORTAINER_SUBDOMAIN}.${env.DEFAULT_DOMAIN}"
                echo "ðŸŒ Network: ${env.TRAEFIK_NETWORK}"
                echo "================================"
            }
        }
        failure {
            script {
                echo "âŒ Erro durante a configuraÃ§Ã£o do Traefik e Portainer!"
                echo "Verifique os logs acima para mais detalhes."
            }
        }
    }
} 