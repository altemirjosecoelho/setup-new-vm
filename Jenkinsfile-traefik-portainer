pipeline {
    agent {
        label 'jenkins-testes'
    }
    
    options {
        // Timeout para evitar builds infinitos
        timeout(time: 30, unit: 'MINUTES')
        // Desabilitar builds concorrentes
        disableConcurrentBuilds()
        // Manter apenas os Ãºltimos 5 builds
        buildDiscarder(logRotator(numToKeepStr: '5'))
    }
    
    // VariÃ¡veis de ambiente devem ser configuradas no Jenkins:
    // TRAEFIK_SUBDOMAIN=traefik
    // DEFAULT_DOMAIN=exemplo.com
    // PORTAINER_SUBDOMAIN=portainer
    // TRAEFIK_NETWORK=traefik_network
    // ADMIN_PASSWORD=MinhaSenhaSegura123
    
    stages {
        stage('Verificar VariÃ¡veis de Ambiente') {
            steps {
                script {
                    echo "=== VERIFICANDO VARIÃVEIS DE AMBIENTE ==="
                    
                    // Verifica se as variÃ¡veis obrigatÃ³rias estÃ£o definidas
                    def missingVars = []
                    
                    // Verifica TRAEFIK_SUBDOMAIN
                    if (!env.TRAEFIK_SUBDOMAIN) {
                        missingVars.add('TRAEFIK_SUBDOMAIN')
                    } else {
                        echo "âœ… TRAEFIK_SUBDOMAIN: ${env.TRAEFIK_SUBDOMAIN}"
                    }
                    
                    // Verifica DEFAULT_DOMAIN
                    if (!env.DEFAULT_DOMAIN) {
                        missingVars.add('DEFAULT_DOMAIN')
                    } else {
                        echo "âœ… DEFAULT_DOMAIN: ${env.DEFAULT_DOMAIN}"
                    }
                    
                    // Verifica PORTAINER_SUBDOMAIN
                    if (!env.PORTAINER_SUBDOMAIN) {
                        missingVars.add('PORTAINER_SUBDOMAIN')
                    } else {
                        echo "âœ… PORTAINER_SUBDOMAIN: ${env.PORTAINER_SUBDOMAIN}"
                    }
                    
                    // Verifica ADMIN_PASSWORD
                    if (!env.ADMIN_PASSWORD) {
                        missingVars.add('ADMIN_PASSWORD')
                    } else {
                        echo "âœ… ADMIN_PASSWORD: [CONFIGURADA]"
                    }
                    
                    if (missingVars.size() > 0) {
                        error "âŒ VariÃ¡veis obrigatÃ³rias nÃ£o configuradas: ${missingVars.join(', ')}"
                    }
                    
                    // Define a network padrÃ£o se nÃ£o estiver configurada
                    if (!env.TRAEFIK_NETWORK) {
                        env.TRAEFIK_NETWORK = 'traefik_network'
                        echo "â„¹ï¸  TRAEFIK_NETWORK nÃ£o configurada, usando padrÃ£o: traefik_network"
                    } else {
                        echo "âœ… TRAEFIK_NETWORK: ${env.TRAEFIK_NETWORK}"
                    }
                    
                    // Exibe as URLs que serÃ£o configuradas
                    echo ""
                    echo "=== URLs que serÃ£o configuradas ==="
                    echo "ðŸŒ Traefik: https://${env.TRAEFIK_SUBDOMAIN}.${env.DEFAULT_DOMAIN}"
                    echo "ðŸ³ Portainer: https://${env.PORTAINER_SUBDOMAIN}.${env.DEFAULT_DOMAIN}"
                    echo "ðŸŒ Network: ${env.TRAEFIK_NETWORK}"
                    echo "====================================="
                }
            }
        }
        
        stage('Verificar RepositÃ³rio') {
            steps {
                script {
                    echo "Verificando repositÃ³rio..."
                    
                    // Verifica se estamos no workspace correto
                    sh '''
                        echo "ðŸ“ Workspace atual: $(pwd)"
                        echo "=== ESTRUTURA DO WORKSPACE ==="
                        ls -la
                        echo "================================"
                    '''
                    
                    // Verifica se a pasta docker existe
                    sh '''
                        if [ -d "docker" ]; then
                            echo "âœ… Pasta docker encontrada!"
                            cd docker
                            echo "ðŸ“ Acessando pasta: $(pwd)"
                            echo "=== CONTEÃšDO DA PASTA DOCKER ==="
                            ls -la
                            echo "================================"
                        else
                            echo "âŒ Pasta docker nÃ£o encontrada!"
                            echo "Criando pasta docker..."
                            mkdir -p docker
                            cd docker
                            echo "âœ… Pasta docker criada!"
                        fi
                    '''
                }
            }
        }
        
        stage('Criar Network Docker') {
            steps {
                script {
                    echo "Criando network Docker para Traefik..."
                    
                    // Verifica se a network jÃ¡ existe
                    def networkName = env.TRAEFIK_NETWORK ?: 'traefik_network'
                    def networkExists = sh(
                        script: "docker network ls --format '{{.Name}}' | grep -w '${networkName}'",
                        returnStatus: true
                    ) == 0
                    
                    if (!networkExists) {
                        sh "docker network create ${networkName}"
                        echo "âœ… Network ${networkName} criada com sucesso!"
                    } else {
                        echo "â„¹ï¸  Network ${networkName} jÃ¡ existe!"
                    }
                }
            }
        }
        
        stage('Verificar e Configurar Docker Compose') {
            steps {
                script {
                    echo "Verificando arquivos Docker Compose existentes..."
                    
                    // Gera hash da senha para o Traefik
                    def passwordHash = ""
                    
                    // Tenta usar htpasswd se disponÃ­vel
                    def htpasswdAvailable = sh(
                        script: "which htpasswd",
                        returnStatus: true
                    ) == 0
                    
                    if (htpasswdAvailable) {
                        passwordHash = sh(
                            script: "htpasswd -nbB admin '${env.ADMIN_PASSWORD}' | cut -d ':' -f 2",
                            returnStdout: true
                        ).trim()
                        echo "âœ… Hash gerado usando htpasswd"
                    } else {
                        // Instala apache2-utils se nÃ£o estiver disponÃ­vel
                        echo "ðŸ“¦ htpasswd nÃ£o encontrado, instalando apache2-utils..."
                        sh "apt-get update && apt-get install -y apache2-utils"
                        
                        // Tenta gerar o hash novamente
                        def hashResult = sh(
                            script: "htpasswd -nbB admin '${env.ADMIN_PASSWORD}' | cut -d ':' -f 2",
                            returnStatus: true
                        )
                        
                        if (hashResult == 0) {
                            passwordHash = sh(
                                script: "htpasswd -nbB admin '${env.ADMIN_PASSWORD}' | cut -d ':' -f 2",
                                returnStdout: true
                            ).trim()
                            echo "âœ… Hash gerado apÃ³s instalaÃ§Ã£o do apache2-utils"
                        } else {
                            // Fallback: usa Python para gerar hash bcrypt
                            echo "âš ï¸  htpasswd falhou, usando Python para gerar hash..."
                            passwordHash = sh(
                                script: "python3 -c \"import bcrypt; import sys; print(bcrypt.hashpw('${env.ADMIN_PASSWORD}'.encode('utf-8'), bcrypt.gensalt()).decode('utf-8'))\"",
                                returnStdout: true
                            ).trim()
                                                    echo "âœ… Hash gerado usando Python bcrypt"
                    }
                    
                    // Verifica se o hash foi gerado corretamente
                    if (!passwordHash || passwordHash.isEmpty()) {
                        error "âŒ Erro: NÃ£o foi possÃ­vel gerar o hash da senha!"
                    }
                    
                    echo "âœ… Hash da senha gerado com sucesso: ${passwordHash.take(20)}..."
                    }
                    
                    // Cria arquivo .env com as variÃ¡veis
                    def traefikSubdomain = env.TRAEFIK_SUBDOMAIN
                    def defaultDomain = env.DEFAULT_DOMAIN
                    def portainerSubdomain = env.PORTAINER_SUBDOMAIN
                    def traefikNetwork = env.TRAEFIK_NETWORK ?: 'traefik_network'
                    def defaultEmail = env.DEFAULT_EMAIL ?: "admin@${env.DEFAULT_DOMAIN}"
                    
                    sh """
                        cd docker
                        cat > .env << 'EOF'
TRAEFIK_SUBDOMAIN=${traefikSubdomain}
DEFAULT_DOMAIN=${defaultDomain}
PORTAINER_SUBDOMAIN=${portainerSubdomain}
ADMIN_PASSWORD_HASH=${passwordHash}
TRAEFIK_NETWORK=${traefikNetwork}
DEFAULT_EMAIL=${defaultEmail}
EOF
                    """
                    
                    echo "âœ… Arquivo .env criado com as variÃ¡veis de ambiente!"
                    
                    // Verifica se o arquivo .env foi criado corretamente
                    def envFileExists = sh(
                        script: "cd docker && test -f .env",
                        returnStatus: true
                    ) == 0
                    
                    if (!envFileExists) {
                        error "âŒ Erro: Arquivo .env nÃ£o foi criado corretamente!"
                    }
                    
                    echo "âœ… Arquivo .env verificado e existe!"
                    
                    // Lista todos os arquivos docker-compose existentes
                    sh '''
                        cd docker
                        echo "=== ARQUIVOS DOCKER COMPOSE ENCONTRADOS ==="
                        ls -la docker-compose*.yml
                        echo "=========================================="
                        
                        echo "=== CONTEÃšDO DO DOCKER-COMPOSE.TRAEFIK.YML ==="
                        if [ -f docker-compose.traefik.yml ]; then
                            cat docker-compose.traefik.yml
                        else
                            echo "âŒ docker-compose.traefik.yml nÃ£o encontrado!"
                        fi
                        echo "============================================="
                        
                        echo "=== CONTEÃšDO DO DOCKER-COMPOSE.PORTAINER.YML ==="
                        if [ -f docker-compose.portainer.yml ]; then
                            cat docker-compose.portainer.yml
                        else
                            echo "âŒ docker-compose.portainer.yml nÃ£o encontrado!"
                        fi
                        echo "==============================================="
                    '''
                    
                    // Exibe o conteÃºdo do arquivo .env
                    sh '''
                        echo "=== CONTEÃšDO DO ARQUIVO .ENV ==="
                        cat .env
                        echo "================================"
                    '''
                    
                    // Cria diretÃ³rios necessÃ¡rios se nÃ£o existirem
                    sh '''
                        cd docker
                        mkdir -p traefik/config traefik/certificates portainer/data
                        echo "âœ… DiretÃ³rios criados/verificados!"
                    '''
                }
            }
        }
        
        stage('Executar Docker Compose') {
            steps {
                script {
                    echo "Executando Docker Compose..."
                    
                    echo "ðŸš€ Executando docker compose up traefik..."
                    sh '''
                        cd docker
                        docker compose -f docker-compose.traefik.yml --env-file .env up -d
                    '''
                    
                    echo "ðŸš€ Executando docker compose up portainer..."
                    sh '''
                        cd docker
                        docker compose -f docker-compose.portainer.yml --env-file .env up -d
                    '''
                    
                    echo "âœ… Docker Compose executado com sucesso!"
                    
                    // Verifica status dos containers
                    sh '''
                        echo "=== STATUS DOS CONTAINERS ==="
                        docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
                        echo "============================="
                    '''
                }
            }
        }
        
        stage('Verificar Status dos Containers') {
            steps {
                script {
                    echo "Verificando status dos containers..."
                    
                    sh '''
                        echo "=== STATUS DOS CONTAINERS ==="
                        docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
                        echo ""
                        echo "=== LOGS DO TRAEFIK ==="
                        docker logs --tail 10 traefik
                        echo ""
                        echo "=== LOGS DO PORTAINER ==="
                        docker logs --tail 10 portainer
                        echo ""
                        echo "=== NETWORKS ==="
                        docker network ls
                        echo ""
                        echo "=== VOLUMES ==="
                        docker volume ls
                    '''
                }
            }
        }
    }
    
    post {
        always {
            script {
                echo "Pipeline de configuraÃ§Ã£o do Traefik e Portainer concluÃ­do!"
                
                // Limpeza de arquivos temporÃ¡rios
                sh '''
                    echo "ðŸ§¹ Limpando arquivos temporÃ¡rios..."
                    rm -f /tmp/*.tmp 2>/dev/null || true
                '''
            }
        }
        success {
            script {
                def traefikSubdomain = env.TRAEFIK_SUBDOMAIN ?: 'traefik'
                def defaultDomain = env.DEFAULT_DOMAIN ?: 'exemplo.com'
                def portainerSubdomain = env.PORTAINER_SUBDOMAIN ?: 'portainer'
                def traefikNetwork = env.TRAEFIK_NETWORK ?: 'traefik_network'
                
                echo "âœ… Traefik e Portainer configurados com sucesso!"
                echo ""
                echo "=== RESUMO DA CONFIGURAÃ‡ÃƒO ==="
                echo "ðŸŒ Traefik Dashboard: https://${traefikSubdomain}.${defaultDomain}"
                echo "ðŸ‘¤ UsuÃ¡rio Traefik: admin"
                echo "ðŸ”‘ Senha Traefik: [configurada via ADMIN_PASSWORD]"
                echo ""
                echo "ðŸ³ Portainer Dashboard: https://${portainerSubdomain}.${defaultDomain}"
                echo "ðŸŒ Network: ${traefikNetwork}"
                echo "================================"
            }
        }
        failure {
            script {
                echo "âŒ Erro durante a configuraÃ§Ã£o do Traefik e Portainer!"
                echo "Verifique os logs acima para mais detalhes."
                
                // InformaÃ§Ãµes de debug em caso de falha
                sh '''
                    echo "=== DEBUG INFO ==="
                    echo "Docker status:"
                    docker ps -a 2>/dev/null || echo "Docker nÃ£o disponÃ­vel"
                    echo ""
                    echo "Network status:"
                    docker network ls 2>/dev/null || echo "Docker nÃ£o disponÃ­vel"
                    echo "=================="
                '''
            }
        }
        cleanup {
            script {
                echo "ðŸ§¹ Executando limpeza final..."
                // Garantir que nÃ£o deixamos arquivos temporÃ¡rios
                sh '''
                    find /tmp -name "*.tmp" -delete 2>/dev/null || true
                '''
            }
        }
    }
} 