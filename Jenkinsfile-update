pipeline {
    agent {
        label 'jenkins-testes'
    }
    
    stages {
        stage('Atualizar Repositórios') {
            steps {
                script {
                    echo "Iniciando atualização dos repositórios..."
                    sh 'apt update'
                    echo "Repositórios atualizados com sucesso!"
                }
            }
        }
        
        stage('Atualizar Pacotes') {
            steps {
                script {
                    echo "Iniciando atualização dos pacotes..."
                    sh 'apt upgrade -y'
                    echo "Pacotes atualizados com sucesso!"
                }
            }
        }
        
        stage('Verificar e Instalar Docker') {
            steps {
                script {
                    echo "Verificando arquitetura do sistema..."
                    
                    // Detecta a arquitetura do processador
                    def architecture = sh(
                        script: 'uname -m',
                        returnStdout: true
                    ).trim()
                    
                    echo "Arquitetura detectada: ${architecture}"
                    
                    // Mapeia a arquitetura para o formato do Docker Compose
                    def dockerComposeArch = ""
                    if (architecture == "x86_64") {
                        dockerComposeArch = "x86_64"
                        echo "Processador AMD64 detectado"
                    } else if (architecture == "aarch64" || architecture == "arm64") {
                        dockerComposeArch = "aarch64"
                        echo "Processador ARM64 detectado"
                    } else {
                        error "Arquitetura não suportada: ${architecture}"
                    }
                    
                    echo "Verificando se o Docker está instalado..."
                    
                    // Verifica se o Docker está instalado
                    def dockerInstalled = sh(
                        script: 'which docker',
                        returnStatus: true
                    ) == 0
                    
                    if (!dockerInstalled) {
                        echo "Docker não encontrado. Instalando..."
                        sh '''
                            # Adicionar repositório oficial do Docker
                            apt-get update
                            apt-get install -y ca-certificates curl gnupg lsb-release
                            mkdir -p /etc/apt/keyrings
                            curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
                            echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null
                            
                            # Instalar Docker
                            apt-get update
                            apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
                            
                            # Adicionar usuário jenkins ao grupo docker
                            usermod -aG docker jenkins
                        '''
                        echo "Docker instalado com sucesso!"
                    } else {
                        echo "Docker já está instalado!"
                        sh 'docker --version'
                    }
                    
                    // Verifica se o Docker Compose está instalado
                    def dockerComposeInstalled = sh(
                        script: 'which docker-compose',
                        returnStatus: true
                    ) == 0
                    
                    if (!dockerComposeInstalled) {
                        echo "Docker Compose não encontrado. Instalando para arquitetura ${dockerComposeArch}..."
                        sh """
                            # Instalar Docker Compose para a arquitetura específica
                            curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-linux-${dockerComposeArch}" -o /usr/local/bin/docker-compose
                            chmod +x /usr/local/bin/docker-compose
                        """
                        echo "Docker Compose instalado com sucesso para ${dockerComposeArch}!"
                    } else {
                        echo "Docker Compose já está instalado!"
                        sh 'docker-compose --version'
                    }
                    
                    // Verifica se o Docker está funcionando
                    sh 'docker info'
                    echo "Verificação do Docker concluída!"
                }
            }
        }
        
        stage('Verificar e Instalar Node.js v21') {
            steps {
                script {
                    echo "Verificando se o Node.js v21 está instalado..."
                    
                    // Verifica se o Node.js está instalado e qual versão
                    def nodeInstalled = sh(
                        script: 'which node',
                        returnStatus: true
                    ) == 0
                    
                    def nodeVersion = ""
                    if (nodeInstalled) {
                        nodeVersion = sh(
                            script: 'node --version',
                            returnStdout: true
                        ).trim()
                        echo "Node.js encontrado: ${nodeVersion}"
                    }
                    
                    // Verifica se é a versão 21.x
                    def needsInstall = !nodeInstalled || !nodeVersion.startsWith("v21")
                    
                    if (needsInstall) {
                        echo "Node.js v21 não encontrado. Instalando..."
                        
                        // Detecta a arquitetura novamente para o Node.js
                        def architecture = sh(
                            script: 'uname -m',
                            returnStdout: true
                        ).trim()
                        
                        def nodeArch = ""
                        if (architecture == "x86_64") {
                            nodeArch = "x64"
                            echo "Instalando Node.js v21 para AMD64"
                        } else if (architecture == "aarch64" || architecture == "arm64") {
                            nodeArch = "arm64"
                            echo "Instalando Node.js v21 para ARM64"
                        } else {
                            error "Arquitetura não suportada para Node.js: ${architecture}"
                        }
                        
                        sh """
                            # Remover versões antigas do Node.js se existirem
                            if command -v node &> /dev/null; then
                                echo "Removendo versão anterior do Node.js..."
                                apt-get remove -y nodejs npm
                                rm -rf /usr/local/bin/node /usr/local/bin/npm
                            fi
                            
                            # Baixar e instalar Node.js v21
                            cd /tmp
                            curl -fsSL https://nodejs.org/dist/v21.7.1/node-v21.7.1-linux-${nodeArch}.tar.xz -o nodejs.tar.xz
                            tar -xf nodejs.tar.xz
                            mv node-v21.7.1-linux-${nodeArch} /usr/local/nodejs
                            
                            # Criar links simbólicos
                            ln -sf /usr/local/nodejs/bin/node /usr/local/bin/node
                            ln -sf /usr/local/nodejs/bin/npm /usr/local/bin/npm
                            ln -sf /usr/local/nodejs/bin/npx /usr/local/bin/npx
                            
                            # Limpar arquivos temporários
                            rm -f nodejs.tar.xz
                            
                            # Atualizar PATH para sessão atual
                            export PATH=/usr/local/bin:\$PATH
                        """
                        
                        echo "Node.js v21 instalado com sucesso!"
                    } else {
                        echo "Node.js v21 já está instalado!"
                    }
                    
                    // Verifica a instalação
                    sh '''
                        echo "=== Verificação do Node.js ==="
                        node --version
                        npm --version
                        npx --version
                        echo "=== Verificação concluída ==="
                    '''
                }
            }
        }
        
        stage('Verificar Status') {
            steps {
                script {
                    echo "Verificando status do sistema após atualizações..."
                    sh '''
                        echo "=== Informações do Sistema ==="
                        echo "Data/Hora: $(date)"
                        echo "Uptime: $(uptime)"
                        echo "Versão do Kernel: $(uname -r)"
                        echo "Distribuição: $(lsb_release -d | cut -f2)"
                        echo "=== Espaço em Disco ==="
                        df -h
                        echo "=== Memória ==="
                        free -h
                    '''
                }
            }
        }
    }
    
    post {
        always {
            script {
                echo "Pipeline de atualização do sistema concluído!"
            }
        }
        success {
            script {
                echo "✅ Atualizações realizadas com sucesso!"
            }
        }
        failure {
            script {
                echo "❌ Erro durante as atualizações!"
            }
        }
    }
} 